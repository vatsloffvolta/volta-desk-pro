<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoltaDesk Pro Futures</title>
  <style id="theme-style">
    :root {
      --bg: #000;
      --text: #fff;
      --input: #222;
      --border: #444;
      --btn: #333;
      --green: #4caf50;
      --red: #f44336;
      --orange: #ff9800;
      --lemon: #cddc39;
      --blue: #2196f3;
      --volume-orange: #cc5500;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Segoe UI, sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 16px; }
    #exchange-time {
      font-size: 1.4rem; font-weight: bold; text-align: center;
      padding: 10px; background: rgba(255,255,255,0.05);
      margin-bottom: 12px; border-radius: 6px;
      letter-spacing: 1px;
    }
    .top-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }
    #theme-toggle {
      width: 36px; height: 36px; border-radius: 50%; background: var(--btn);
      border: 1px solid var(--border); cursor: pointer; display: flex;
      align-items: center; justify-content: center; font-size: 1.2rem;
    }
    .header { display: flex; justify-content: space-between; margin-bottom: 16px; align-items: center; }
    .logo { font-size: 1.8rem; color: #00bfff; font-weight: bold; }
    h3 { margin: 12px 0 8px; font-size: 1.1rem; }
    label { display: block; font-size: 0.85rem; opacity: 0.8; margin-bottom: 4px; }
    input, select, button { width: 100%; padding: 8px; margin-bottom: 8px; background: var(--input); border: 1px solid var(--border); color: var(--text); border-radius: 4px; }
    input[readonly] { background: #111; }
    button { background: var(--btn); cursor: pointer; font-weight: bold; }
    button:hover { opacity: 0.9; }
    .mode-profile-row {
      display: flex; gap: 12px; flex-wrap: wrap; align-items: stretch;
      margin-bottom: 12px;
    }
    .profile-group, .pos-buttons {
      display: flex; gap: 4px; flex-wrap: wrap; align-items: stretch;
    }
    .profile-btn, #btnLong, #btnShort {
      flex: 1;
      padding: 8px;
      font-size: 0.85rem;
      text-align: center;
      background: var(--btn);
      border: 1px solid var(--border);
      border-radius: 4px;
      white-space: nowrap;
      line-height: 1.2;
    }
    #btnLong.active { border-color: var(--green); }
    #btnShort.active { border-color: var(--red); }
    body[data-theme="dark"] #btnLong.active { color: #81c784; }
    body[data-theme="dark"] #btnShort.active { color: #e57373; }
    .profile-btn.active {
      box-shadow: 0 -3px 0 0 var(--orange) inset;
      border: 2px solid var(--orange);
    }
    .btn-group { display: flex; gap: 8px; margin: 12px 0; }
    .btn-group > * { flex: 1; }
    .schema-display {
      text-align: center; font-family: monospace; font-size: 1.4rem;
      padding: 12px; background: var(--input); border-radius: 6px;
      margin-bottom: 4px;
      color: var(--orange);
      text-shadow: 0 0 6px rgba(255,152,0,0.3);
    }
    .schema-hint {
      text-align: center;
      font-size: 0.75rem;
      opacity: 0.6;
      margin-bottom: 8px;
    }
    .output { background: var(--input); padding: 12px; border-radius: 6px; font-family: monospace; max-height: 200px; overflow: auto; }
    .log { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th, td { padding: 6px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: rgba(255,255,255,0.05); white-space: nowrap; }
    td { font-family: monospace; }
    .tp-row { grid-column: span 2; margin-top: 8px; }
    .tp-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 6px; }
    .tp-cell input { text-align: center; font-weight: bold; }
    #tp1Price { color: #4caf50; }
    #tp2Price { color: #81c784; }
    #tp3Price { color: #cddc39; }
    #tp4Price { color: #ff9800; }
    #customTickerRow { display: none; margin-top: 4px; }
    .save-row { display: flex; gap: 6px; margin-top: 4px; }
    #devtools-warning {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      color: #ff9800;
      font-size: 1.2rem;
      text-align: center;
      padding: 20vh 20px;
      z-index: 9999;
    }
    #devtools-warning button {
      margin-top: 20px;
      padding: 10px 20px;
      background: #333;
      color: white;
      border: 0;
      border-radius: 4px;
      cursor: pointer;
    }
    #watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 0.8rem;
      opacity: 0.3;
      pointer-events: none;
      display: none;
    }
    .demo-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 0.85rem;
      font-weight: normal;
      background: rgba(128,128,128,0.1);
      color: #aaa;
      padding: 4px 10px;
      border-radius: 4px;
      z-index: 999;
      pointer-events: none;
    }
    #helpModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 10000;
    }
    #helpModal .content {
      width: 90%;
      max-width: 600px;
      background: #111;
      margin: 40px auto;
      padding: 20px;
      border-radius: 8px;
      color: #fff;
      font-family: Segoe UI;
      font-size: 0.95rem;
      line-height: 1.5;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }
    #helpModal h3 {
      margin-top: 0;
      color: #ff9800;
    }
    #helpModal h4 {
      color: #2196f3;
      margin: 16px 0 8px;
    }
    #helpModal p {
      margin: 10px 0;
    }
    #helpModal ul {
      margin: 8px 0 12px;
      padding-left: 20px;
      font-size: 0.95rem;
    }
    #helpModal code {
      background: #444;
      padding: 1px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
    #helpModal button {
      margin-top: 16px;
      background: #ff9800;
      color: #000;
      border: 0;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #depo, #go {
      font-size: 1.1rem !important;
      padding: 10px 8px !important;
      height: 36px !important;
    }
    .debug-log {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: #0f0;
      font-family: monospace;
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 4px;
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body data-theme="dark">
<div class="debug-log" id="debugLog"></div>
<div class="top-bar">
  <div id="exchange-time">--:--:-- (RT) üá∑üá∫</div>
  <button id="theme-toggle">üåô</button>
</div>
<div class="header">
  <div class="logo">VoltaDesk Pro</div>
  <div>VoltaDesk Pro Futures ‚Ä¢ V2.4.1 ‚Äî by –í—è—á–µ—Å–ª–∞–≤</div>
  <div style="display:flex;gap:8px;align-items:center;">
    <input type="text" id="licenseToken" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω" 
           style="width:220px;padding:6px 8px;background:#222;border:1px solid #444;color:#fff;font-size:0.85rem;">
    <button id="btnActivate" style="
      padding:6px 12px;background:#2196f3;color:white;border:0;border-radius:4px;
      font-weight:bold;cursor:pointer;font-size:0.85rem;
    ">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>
<div class="demo-badge" id="demoBadge">DEMO</div>
<div id="watermark">VoltaDesk.Pro ‚Ä¢ DEMO</div>
<h3>1. –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;">
  <div><label>–î–µ–ø–æ–∑–∏—Ç (‚ÇΩ)</label><input type="number" id="depo" value="50000" step="1000"></div>
  <div>
    <label>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label>
    <select id="instr" style="height:36px;"></select>
  </div>
  <div><label>–ì–û –Ω–∞ –ª–æ—Ç (‚ÇΩ)</label><input type="number" id="go" value="5210" step="100"></div>
  <div><label>–®–∞–≥ —Ü–µ–Ω—ã</label><input type="number" id="priceStep" value="0.01" step="0.001" min="0.001"></div>
  <div><label>–°—Ç–æ–∏–º–æ—Å—Ç—å —à–∞–≥–∞, ‚ÇΩ</label><input type="number" id="stepCost" value="1" step="0.01" min="0.01"></div>
  <div><label>–†–∏—Å–∫ (%)</label><input type="number" id="riskPct" value="3" min="0.1" max="5" step="0.1"></div>
  <div><label>–†–∏—Å–∫ (‚ÇΩ)</label><input type="number" id="riskRub" value="1500" step="10"></div>
  <div><label>–¶–µ–Ω–∞</label><input type="number" id="price" value="308.50" step="0.01"></div>
  <div><label>–°—Ç–æ–ø-–ª–æ—Å—Å (‚ÇΩ)</label><input type="number" id="slPrice" value="301.50" step="0.01"></div>
  <div><label>–°—Ç–æ–ø-–ª–æ—Å—Å (—à–∞–≥–∏)</label><input type="number" id="sl" value="700" step="10" readonly></div>
  <div><label>ATR (—à–∞–≥–∏)</label><input type="number" id="atr" placeholder="–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ" step="100"></div>
</div>
<div class="tp-row">
  <div class="tp-grid">
    <div class="tp-cell">
      <label style="color:#4caf50;font-size:0.85rem;">–£—Ä–æ–≤–µ–Ω—å –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è TP1</label>
      <input type="text" id="tp1Price" readonly placeholder="315.50">
    </div>
    <div class="tp-cell">
      <label style="color:#81c784;font-size:0.85rem;">–£—Ä–æ–≤–µ–Ω—å –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è TP2</label>
      <input type="text" id="tp2Price" readonly placeholder="322.00">
    </div>
    <div class="tp-cell">
      <label style="color:#cddc39;font-size:0.85rem;">–£—Ä–æ–≤–µ–Ω—å –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è TP3</label>
      <input type="text" id="tp3Price" readonly placeholder="329.00">
    </div>
    <div class="tp-cell">
      <label style="color:#ff9800;font-size:0.85rem;">–£—Ä–æ–≤–µ–Ω—å –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è TP4</label>
      <input type="text" id="tp4Price" readonly placeholder="343.00">
    </div>
  </div>
</div>
<div id="customTickerRow">
  <label>–¢–∏–∫–µ—Ä</label>
  <input type="text" id="customTickerInput" placeholder="–ù–∞–ø—Ä., RTS-6.25" style="width:100%;padding:6px;background:var(--input);border:1px solid var(--border);color:var(--text);">
  <div class="save-row">
    <button id="btnSaveInstrument" style="flex:1;background:#2196f3;color:white;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <select id="savedInstruments" style="flex:2;height:36px;"></select>
  </div>
</div>
<h3>2. –ü—Ä–æ—Ñ–∏–ª—å & –ü–æ–∑–∏—Ü–∏—è</h3>
<div class="mode-profile-row">
  <div style="flex:2;">
    <label>–ü—Ä–æ—Ñ–∏–ª—å</label>
    <div class="profile-group">
      <button class="profile-btn active" data-profile="cons">–ö–æ–Ω—Å ‚Ä¢|‚Ä¢|‚Ä¢|‚Äì</button>
      <button class="profile-btn" data-profile="bal">–ë–∞–ª–∞–Ω—Å ‚Ä¢‚Ä¢|‚Ä¢|‚Ä¢|‚Äì</button>
      <button class="profile-btn" data-profile="aggr">–ê–≥—Ä–µ—Å—Å ‚Ä¢|‚Ä¢|‚Ä¢|‚Ä¢‚Ä¢</button>
      <button class="profile-btn" id="btnAutoProfile">–ê–≤—Ç–æ-–ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </div>
  <div style="flex:1; display:flex;flex-direction:column;justify-content:space-between;">
    <label>–ü–æ–∑–∏—Ü–∏—è</label>
    <div class="pos-buttons">
      <button id="btnLong" class="green active">Long</button>
      <button id="btnShort" class="red">Short</button>
    </div>
  </div>
</div>
<h3>3. –†–∞—Å—á—ë—Ç</h3>
<div class="schema-display" id="schemeVis">‚Ä¢|‚Ä¢|‚Ä¢|‚Äì</div>
<div class="schema-hint">–°—Ö–µ–º–∞: –ª–æ—Ç—ã –Ω–∞ TP1|TP2|TP3|TP4</div>
<div id="rrDisplay" style="text-align:center;font-size:0.85rem;opacity:0.7;margin-top:0;">
  R:R ‚âà 2.0
</div>
<div class="output" id="out">–ù–∞–∂–º–∏—Ç–µ ¬´–†–∞—Å—Å—á–∏—Ç–∞—Ç—å¬ª</div>
<div class="btn-group">
  <button id="btnCalc">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
  <button id="btnLog">–í –∂—É—Ä–Ω–∞–ª</button>
</div>
<h3 class="log">–ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫</h3>
<table id="logTable">
  <thead>
    <tr>
      <th>–í—Ä–µ–º—è</th>
      <th>–¢–∏–∫–µ—Ä</th>
      <th>Pos</th>
      <th>–°—Ö–µ–º–∞</th>
      <th>–õ–æ—Ç–æ–≤</th>
      <th>SL (—à–∞–≥–∏)</th>
      <th>TP1‚ÄìTP4 (‚ÇΩ)</th>
      <th>–ü—Ä–∏–±—ã–ª—å (‚ÇΩ)</th>
    </tr>
  </thead>
  <tbody id="logBody">
    <tr><td colspan="8" style="text-align:center">‚Äî –ø—É—Å—Ç–æ ‚Äî</td></tr>
  </tbody>
</table>
<div class="btn-group">
  <button id="btnExpExcel" style="background:#4caf50;color:white;">Excel</button>
  <button id="btnExpWord" style="background:#2196f3;color:white;">Word</button>
  <button id="btnClearLog" style="background:#f44336;color:white;width:50%;">–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
  <button id="btnBackup" style="background:#9c27b0;color:white;width:50%;">–ë—ç–∫–∞–ø –∂—É—Ä–Ω–∞–ª–∞</button>
</div>
<div style="position:fixed;bottom:16px;right:16px;">
  <button style="background:#ff9800;color:#000;border:none;border-radius:50%;width:40px;height:40px;font-weight:bold;cursor:pointer;" id="btnHelp">?</button>
</div>
<div id="devtools-warning">
  <div>
    ‚ö†Ô∏è DevTools –æ–±–Ω–∞—Ä—É–∂–µ–Ω.<br>
    –ö–æ–Ω—Ç–µ–Ω—Ç —Å–∫—Ä—ã—Ç –≤ —Ü–µ–ª—è—Ö –∑–∞—â–∏—Ç—ã –ü–û.<br>
    <button onclick="document.getElementById('devtools-warning').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</button>
  </div>
</div>
<div id="helpModal">
  <div class="content">
    <h3>VoltaDesk Pro Futures ‚Ä¢ V2.4.1</h3>
    <p>–í–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏.<br>
    –í—Å–µ —Ä–∞—Å—á—ë—Ç—ã ‚Äî –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ù–∏–∫–∞–∫–∏—Ö –æ–±–ª–∞–∫–æ–≤. –ù–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö.</p>
    <h4>üöÄ –ö–∞–∫ –Ω–∞—á–∞—Ç—å</h4>
    <p>1Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ ¬´–°–≤–æ–π¬ª)<br>
       2Ô∏è‚É£ –£–∫–∞–∂–∏—Ç–µ: –¥–µ–ø–æ–∑–∏—Ç, —Ü–µ–Ω–∞, —Å—Ç–æ–ø-–ª–æ—Å—Å (–≤ ‚ÇΩ)<br>
       3Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ ¬´–†–∞—Å—Å—á–∏—Ç–∞—Ç—å¬ª ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ TP1‚ÄìTP4 –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª<br>
       4Ô∏è‚É£ ¬´–í –∂—É—Ä–Ω–∞–ª¬ª ‚Äî —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
    <h4>üîí –î–µ–º–æ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è</h4>
    <p>‚Ä¢ –î–µ–º–æ-—Ä–µ–∂–∏–º: <b>3 –¥–Ω—è</b> ‚Äî –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.<br>
       ‚Ä¢ –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è.<br>
       ‚Ä¢ –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã: <b>–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ Pro-–≤–µ—Ä—Å–∏—é –∑–∞ 4 990 ‚ÇΩ</b>.</p>
    <h4>üí≥ –ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω</h4>
    <p>1. –û–ø–ª–∞—Ç–∏—Ç–µ <b>4 990 ‚ÇΩ</b> —á–µ—Ä–µ–∑ –°–ë–ü (QR –≤—ã—à–ª—é –ø–æ –∑–∞–ø—Ä–æ—Å—É).<br>
       2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω –æ–ø–ª–∞—Ç—ã + –≤–∞—à email –Ω–∞: <b>VoltaDesk.Pro@yandex.ru</b><br>
       3. –í —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∏–¥–∞:<br>
       <code>VD-FUT-2025-ivan_gmail_com-AB3C9D</code><br>
       4. –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ ¬´–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω¬ª ‚Üí –Ω–∞–∂–º–∏—Ç–µ ¬´–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å¬ª.</p>
    <p>üìå –í —Å–ª—É—á–∞–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—è ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–æ–∫–µ–Ω–∞. –û—Ç–≤–µ—Ç ‚Äî –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.</p>
    <p><small>
      ‚ö†Ô∏è –ê–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–ª–∏ —Ç–æ—Ä–≥–æ–≤–ª—é –±–µ–∑ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–æ–º.<br>
      üìß –í–æ–ø—Ä–æ—Å—ã: <b>VoltaDesk.Pro@yandex.ru</b>
    </small></p>
    <button onclick="document.getElementById('helpModal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // === DEBUG MODE ===
  const urlParams = new URLSearchParams(window.location.search);
  const DEBUG = urlParams.has('demo_debug') && urlParams.get('demo_debug') === '1';
  const debugLog = document.getElementById('debugLog');
  if (DEBUG) debugLog.style.display = 'block';
  function dlog(...args) {
    if (!DEBUG) return;
    console.log('[DEBUG]', ...args);
    debugLog.textContent += args.map(x => typeof x === 'object' ? JSON.stringify(x, null, 1) : x).join(' ') + '\n';
  }

  // === 1. CANVAS FINGERPRINT (—Å—Ç–æ–π–∫–∏–π) ===
  function getCanvasFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 200;
    canvas.height = 50;
    ctx.textBaseline = 'top';
    ctx.font = "14px 'Arial'";
    ctx.textAlign = 'left';
    ctx.fillStyle = '#f60';
    ctx.fillRect(0, 0, 200, 50);
    ctx.fillStyle = '#069';
    ctx.fillText('VoltaDesk.Pro', 2, 15);
    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
    ctx.fillText('canvas.fp', 4, 32);
    return canvas.toDataURL().substring(0, 64);
  }

  // === 2. INDEXEDDB ===
  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('VoltaGuardDB', 2);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => resolve(req.result);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('meta')) {
          db.createObjectStore('meta');
        }
      };
    });
  }
  async function getDB(key) {
    try {
      const db = await openDB();
      return new Promise(resolve => {
        const tx = db.transaction('meta', 'readonly');
        const store = tx.objectStore('meta');
        const req = store.get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
      });
    } catch (e) { return null; }
  }
  async function setDB(key, value) {
    try {
      const db = await openDB();
      const tx = db.transaction('meta', 'readwrite');
      const store = tx.objectStore('meta');
      store.put(value, key);
      await new Promise(r => tx.oncomplete = r);
    } catch (e) {}
  }

  // === 3. TIME GUARD ===
  async function initTimeGuard() {
    return new Promise(resolve => {
      try {
        const blob = new Blob([`
          self.onmessage = () => {
            const now = Date.now(), perf = performance.now();
            postMessage({ now, perf });
          };
        `], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        const w = new Worker(url);
        w.onmessage = e => {
          const { now, perf } = e.data;
          const jsNow = Date.now(), jsPerf = performance.now();
          const dT = Math.abs(now - jsNow), dP = Math.abs(perf - jsPerf);
          if (dT > 500 || dP > 50) {
            dlog(`‚è±Ô∏è –í—Ä–µ–º—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ: dT=${dT}ms, dP=${dP}ms`);
          }
          resolve(true);
          w.terminate(); URL.revokeObjectURL(url);
        };
        w.postMessage('check');
      } catch (e) {
        dlog('‚è±Ô∏è Worker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
        resolve(true);
      }
    });
  }

  // === 4. MAX DEMO GUARD ===
  async function initDemoGuard() {
    dlog('‚Üí initTimeGuard...');
    const timeOK = await initTimeGuard();
    if (!timeOK) {
      alert('‚ö†Ô∏è –í—Ä–µ–º—è –ø–æ–¥–º–µ–Ω–µ–Ω–æ. –î–µ–º–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.');
      return false;
    }
    const KEY_FIRST_RUN = 'volta_firstRun';
    const KEY_FP = 'volta_fp';
    const KEY_CALC = 'volta_calcCount';
    const canvasFP = getCanvasFingerprint();
    const now = Date.now();
    dlog('üñºÔ∏è canvasFP:', canvasFP.substring(0, 24) + '...');

    const dbFR = await getDB(KEY_FIRST_RUN); dlog('üíæ DB firstRun:', dbFR);
    const dbFP = await getDB(KEY_FP);         dlog('üíæ DB FP:', dbFP?.substring(0, 10));
    const ssFR = sessionStorage.getItem(KEY_FIRST_RUN); dlog('üóÉÔ∏è SS firstRun:', ssFR);
    const lsFR = localStorage.getItem(KEY_FIRST_RUN);   dlog('üóÉÔ∏è LS firstRun:', lsFR);
    const ssFP = sessionStorage.getItem(KEY_FP);
    const lsFP = localStorage.getItem(KEY_FP);
    let firstRun = dbFR || ssFR || lsFR;
    let savedFP = dbFP || ssFP || lsFP;

    if (savedFP === canvasFP && firstRun) {
      dlog('‚úÖ FP —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º firstRun');
      sessionStorage.setItem(KEY_FIRST_RUN, firstRun);
      localStorage.setItem(KEY_FIRST_RUN, firstRun);
      sessionStorage.setItem(KEY_FP, canvasFP);
      localStorage.setItem(KEY_FP, canvasFP);
      setDB(KEY_FIRST_RUN, firstRun);
      setDB(KEY_FP, canvasFP);
    } else {
      dlog('üÜï –ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ‚Äî —Å—Ç–∞—Ä—Ç—É–µ–º –¥–µ–º–æ');
      firstRun = now.toString();
      sessionStorage.setItem(KEY_FIRST_RUN, firstRun);
      localStorage.setItem(KEY_FIRST_RUN, firstRun);
      sessionStorage.setItem(KEY_FP, canvasFP);
      localStorage.setItem(KEY_FP, canvasFP);
      setDB(KEY_FIRST_RUN, firstRun);
      setDB(KEY_FP, canvasFP);
    }

    const elapsedHours = (now - parseInt(firstRun)) / (1000 * 60 * 60);
    dlog(`üïí –ü—Ä–æ—à–ª–æ: ${elapsedHours.toFixed(2)} / 72 —á–∞—Å–æ–≤`);
    if (elapsedHours > 72) {
      dlog('‚ùå –î–µ–º–æ –∏—Å—Ç—ë–∫');
      const calcCount = parseInt(
        (await getDB(KEY_CALC)) ||
        sessionStorage.getItem(KEY_CALC) ||
        localStorage.getItem(KEY_CALC) ||
        '0'
      );
      const savedInstruments = JSON.parse(localStorage.getItem('voltaInstruments') || '[]').length;
      const logCount = JSON.parse(localStorage.getItem('voltaLog') || '[]').length;
      document.body.innerHTML = `
        <div style="
          position:fixed;top:0;left:0;width:100vw;height:100vh;
          background:#000;color:#ff9800;display:flex;flex-direction:column;
          justify-content:center;align-items:center;text-align:center;padding:20px;
          font-family:Segoe UI;line-height:1.6;z-index:99999;
        ">
          <h2 style="font-size:1.8rem;margin:0;">VoltaDesk Pro Futures</h2>
          <p style="font-size:1.2rem;margin:20px 0;">–î–µ–º–æ-–ø–µ—Ä–∏–æ–¥ (3 –¥–Ω—è) –∏—Å—Ç—ë–∫.</p>
          <p>–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ Pro-–≤–µ—Ä—Å–∏—é.</p>
          <p style="opacity:0.7;margin:16px 0;">–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ VoltaDesk:</p>
          <ul style="opacity:0.8;font-size:0.95rem;margin-bottom:20px;text-align:left;max-width:400px;">
            <li>‚Ä¢ —Ä–∞—Å—Å—á–∏—Ç–∞–ª–∏ ${calcCount} —Å—Ö–µ–º</li>
            <li>‚Ä¢ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ ${savedInstruments} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</li>
            <li>‚Ä¢ –¥–æ–±–∞–≤–∏–ª–∏ ${logCount} –∑–∞–ø–∏—Å–µ–π –≤ –∂—É—Ä–Ω–∞–ª</li>
          </ul>
          <button onclick="location.reload()" style="
            background:#333;color:#fff;border:1px solid #ff9800;padding:12px 24px;
            border-radius:6px;font-weight:bold;cursor:pointer;
          ">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <p style="margin-top:30px;font-size:0.85rem;opacity:0.5;">
            VoltaDesk.Pro ‚Ä¢ V2.4.1 ‚Äî by –í—è—á–µ—Å–ª–∞–≤
          </p>
        </div>
      `;
      return false;
    }

    window.incrCalcCount = async () => {
      const n = (parseInt(await getDB(KEY_CALC) || '0')) + 1;
      sessionStorage.setItem(KEY_CALC, n);
      localStorage.setItem(KEY_CALC, n);
      setDB(KEY_CALC, n);
    };
    dlog('‚úÖ –î–µ–º–æ –∞–∫—Ç–∏–≤–µ–Ω');
    return true;
  }

  // === –í–°–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ù–ò–ñ–ï ‚Äî PATCHED ===

  function safeBtoa(str) {
    try {
      return btoa(unescape(encodeURIComponent(str)));
    } catch (e) {
      return '';
    }
  }

  function checkDOMIntegrity() {
    const watermark = document.getElementById('watermark');
    const badge = document.getElementById('demoBadge');
    const tokenInput = document.getElementById('licenseToken');
    if (!watermark || !badge || !tokenInput) return false;
    const styles = getComputedStyle(badge);
    if (styles.pointerEvents !== 'none' || badge.textContent.trim() !== 'DEMO') return false;
    return true;
  }

  function validateToken(token) {
    const parts = token.trim().split('-');
    if (parts.length !== 5 || parts[0] !== 'VD' || parts[1] !== 'FUT' || parts[2] !== '2025') return false;
    const emailSafe = parts[3];
    const hash = parts[4].toUpperCase();
    const expected = safeBtoa(emailSafe + 'volta2025_vtb').substring(0,6).toUpperCase();
    return hash === expected;
  }

  function activatePro(token) {
    try {
      if (validateToken(token)) {
        localStorage.setItem('volta_pro_token', token);
        sessionStorage.setItem('volta_pro_token', token);
        document.getElementById('watermark').style.display = 'none';
        document.getElementById('demoBadge').style.display = 'none';
        document.querySelector('.header > div:last-child').style.display = 'none';
        return true;
      }
    } catch (e) {}
    return false;
  }

  document.getElementById('btnActivate').onclick = () => {
    const token = document.getElementById('licenseToken').value.trim();
    if (activatePro(token)) {
      alert('‚úÖ VoltaDesk Pro –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
      location.reload();
    } else {
      alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ.');
    }
  };

  const token = localStorage.getItem('volta_pro_token') || sessionStorage.getItem('volta_pro_token');
  let isPro = false;
  if (token && validateToken(token)) {
    dlog('üîë PRO: —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω');
    isPro = activatePro(token);
  } else if (token) {
    dlog('üîë –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Äî –æ—á–∏—â–∞–µ–º');
    localStorage.removeItem('volta_pro_token');
    sessionStorage.removeItem('volta_pro_token');
  }

  let demoGuardPassed = false;
  if (isPro) {
    demoGuardPassed = true;
    document.getElementById('watermark').style.display = 'none';
    document.getElementById('demoBadge').style.display = 'none';
    dlog('‚úÖ PRO-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
  } else {
    dlog('üîß –ó–∞–ø—É—Å–∫–∞–µ–º initDemoGuard()...');
    demoGuardPassed = await initDemoGuard();
    if (demoGuardPassed) {
      document.getElementById('watermark').style.display = 'block';
      document.getElementById('demoBadge').style.display = 'block';
      dlog('‚úÖ DEMO-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    }
  }
  if (!demoGuardPassed) return;

  console.clear();
  console.log(
    "%cVoltaDesk PRO FUTURES ‚Ä¢ V2.4.1 ‚Äî –§–æ–∫—É—Å –Ω–∞ —Ñ—å—é—á–µ—Ä—Å—ã\n–ê–≤—Ç–æ—Ä—Å–∫–æ–µ –ü–û –í—è—á–µ—Å–ª–∞–≤–∞. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.",
    "color:#ff9800;font-weight:bold;font-size:14px;background:#000;padding:10px;border-left:4px solid #ff9800;"
  );

  // === –û–°–ù–û–í–ù–û–ô –ö–û–î (—Å –ø–∞—Ç—á–∞–º–∏) ===

  if (typeof window._devtoolsOpen === 'undefined') {
    window._devtoolsOpen = false;
    setInterval(() => {
      const threshold = 160;
      if (
        (window.outerHeight - window.innerHeight > threshold) ||
        (window.outerWidth - window.innerWidth > threshold)
      ) {
        if (!window._devtoolsOpen) {
          window._devtoolsOpen = true;
          document.getElementById('devtools-warning').style.display = 'flex';
        }
      } else {
        window._devtoolsOpen = false;
      }
    }, 1000);
  }

  const instruments = [
    { value: 'sberf', text: 'SBERF (–≤–µ—á–Ω—ã–π)', go: 5210, priceStep: 0.01, stepCost: 1 },
    { value: 'gazp', text: 'GAZP (–≤–µ—á–Ω—ã–π)', go: 2142, priceStep: 0.01, stepCost: 1 },
    { value: 'usdrub', text: 'USD/RUB (–≤–µ—á–Ω—ã–π)', go: 12155, priceStep: 0.01, stepCost: 10 },
    { value: 'imoex', text: 'IMOEX (–≤–µ—á–Ω—ã–π)', go: 2653, priceStep: 0.5, stepCost: 5 },
    { value: 'gold', text: '–ó–æ–ª–æ—Ç–æ (–≤–µ—á–Ω—ã–π)', go: 1065, priceStep: 0.1, stepCost: 0.1 },
    { value: 'srz5', text: 'SBRF-12.25 (SRZ5)', go: 5500, priceStep: 0.01, stepCost: 1 },
    { value: 'custom', text: '–°–≤–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç' }
  ];

  function updateInstruments() {
    const sel = document.getElementById('instr');
    sel.innerHTML = '';
    instruments.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.value;
      opt.textContent = item.text;
      if (item.value === 'sberf') opt.selected = true;
      sel.appendChild(opt);
    });
    sel.dispatchEvent(new Event('change'));
  }
  updateInstruments();

  function updateSavedInstruments() {
    const sel = document.getElementById('savedInstruments');
    sel.innerHTML = '<option value="">‚Äî –ú–æ–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Äî</option>';
    const saved = JSON.parse(localStorage.getItem('voltaInstruments') || '[]');
    saved.forEach(i => {
      const opt = document.createElement('option');
      opt.value = i.ticker;
      opt.textContent = `${i.name} (${i.ticker})`;
      sel.appendChild(opt);
    });
  }

  document.getElementById('instr').addEventListener('change', function() {
    const item = instruments.find(x => x.value === this.value);
    const customRow = document.getElementById('customTickerRow');
    if (item.value === 'custom') {
      customRow.style.display = 'block';
    } else {
      customRow.style.display = 'none';
      document.getElementById('go').value = item.go;
      document.getElementById('priceStep').value = item.priceStep;
      document.getElementById('stepCost').value = item.stepCost;
      document.getElementById('riskPct').value = '3';
      syncRisk();
      updateSLinSteps();
    }
  });

  document.getElementById('btnSaveInstrument').addEventListener('click', () => {
    const ticker = document.getElementById('customTickerInput').value.trim().toUpperCase();
    if (!ticker) return alert('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ç–∏–∫–µ—Ä (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π –∏–ª–∏ —Ü–∏—Ñ—Ä–∞–º–∏)');
    const go = +document.getElementById('go').value;
    const priceStep = +document.getElementById('priceStep').value;
    const stepCost = +document.getElementById('stepCost').value;
    if (isNaN(go) || isNaN(priceStep) || isNaN(stepCost)) {
      return alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è');
    }
    const nameInput = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:', ticker);
    if (nameInput === null) return;
    const name = nameInput.trim() || ticker;
    const instrument = { ticker, go, priceStep, stepCost, name };
    const saved = JSON.parse(localStorage.getItem('voltaInstruments') || '[]');
    const exists = saved.findIndex(i => i.ticker === ticker);
    if (exists >= 0) {
      if (!confirm(`–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ${ticker} —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –û–±–Ω–æ–≤–∏—Ç—å?`)) return;
      saved[exists] = instrument;
    } else {
      saved.push(instrument);
    }
    localStorage.setItem('voltaInstruments', JSON.stringify(saved));
    updateSavedInstruments();
    alert(`‚úÖ ${name} (${ticker}) —Å–æ—Ö—Ä–∞–Ω—ë–Ω`);
  });

  document.getElementById('savedInstruments').addEventListener('change', function() {
    if (!this.value) return;
    const saved = JSON.parse(localStorage.getItem('voltaInstruments') || '[]');
    const inst = saved.find(i => i.ticker === this.value);
    if (inst) {
      document.getElementById('customTickerInput').value = inst.ticker;
      document.getElementById('go').value = inst.go;
      document.getElementById('priceStep').value = inst.priceStep;
      document.getElementById('stepCost').value = inst.stepCost;
      document.getElementById('instr').value = 'custom';
      document.getElementById('instr').dispatchEvent(new Event('change'));
    }
  });

  updateSavedInstruments();

  function updateExchangeTime() {
    const now = new Date();
    document.getElementById('exchange-time').textContent = 
      `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')} (RT) üá∑üá∫`;
  }
  setInterval(updateExchangeTime, 1000);
  updateExchangeTime();

  document.getElementById('theme-toggle').addEventListener('click', () => {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const newTheme = isDark ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme);
    document.body.style.backgroundColor = newTheme === 'dark' ? '#000' : '#fff';
    document.body.style.color = newTheme === 'dark' ? '#fff' : '#000';
    document.getElementById('theme-toggle').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    const bg = newTheme === 'dark' ? '#222' : '#f9f9f9';
    const text = newTheme === 'dark' ? '#fff' : '#000';
    const border = newTheme === 'dark' ? '#444' : '#ccc';
    document.querySelectorAll('input, select, .output, .schema-display, #helpModal .content').forEach(el => {
      el.style.backgroundColor = bg;
      el.style.color = text;
      if (el.tagName !== 'DIV') el.style.border = `1px solid ${border}`;
    });
    document.querySelectorAll('th').forEach(el => {
      el.style.backgroundColor = newTheme === 'dark' ? 'rgba(255,255,255,0.05)' : '#eee';
    });
  });

  document.getElementById('btnLong').addEventListener('click', () => {
    document.getElementById('btnLong').classList.add('active');
    document.getElementById('btnShort').classList.remove('active');
    validateSL();
  });

  document.getElementById('btnShort').addEventListener('click', () => {
    document.getElementById('btnShort').classList.add('active');
    document.getElementById('btnLong').classList.remove('active');
    validateSL();
  });

  function syncRisk() {
    const depo = +document.getElementById('depo').value;
    const pct = +document.getElementById('riskPct').value;
    document.getElementById('riskRub').value = Math.round(depo * pct / 100);
  }

  document.getElementById('riskPct').addEventListener('input', syncRisk);
  document.getElementById('depo').addEventListener('input', syncRisk);

  const profiles = { 
    cons: [0.65, 0.2, 0.1, 0.05], 
    bal: [0.5, 0.25, 0.15, 0.1], 
    aggr: [0.35, 0.25, 0.2, 0.2] 
  };
  let currentProfile = 'cons';

  document.querySelectorAll('[data-profile]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-profile]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentProfile = btn.dataset.profile;
      calculate();
    });
  });

  document.getElementById('btnAutoProfile').addEventListener('click', () => {
    const sl = +document.getElementById('sl').value;
    currentProfile = sl * 3 < 1500 ? 'cons' : sl * 3 <= 2500 ? 'bal' : 'aggr';
    document.querySelectorAll('[data-profile]').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-profile="${currentProfile}"]`).classList.add('active');
    calculate();
  });

  function updateSLinSteps() {
    const price = +document.getElementById('price').value;
    const slPrice = +document.getElementById('slPrice').value;
    const priceStep = +document.getElementById('priceStep').value || 0.01;

    // ‚úÖ PATCH #2: –∑–∞—â–∏—Ç–∞ –æ—Ç NaN
    if (isNaN(price) || isNaN(slPrice) || isNaN(priceStep) || priceStep <= 0) {
      document.getElementById('sl').value = '';
      return;
    }

    const slSteps = Math.abs(price - slPrice) / priceStep;
    document.getElementById('sl').value = Math.round(slSteps);
    validateSL();
  }

  function validateSL() {
    const price = +document.getElementById('price').value;
    const slPrice = +document.getElementById('slPrice').value;
    const isLong = document.getElementById('btnLong').classList.contains('active');
    const slInput = document.getElementById('slPrice');
    const priceInput = document.getElementById('price');

    // ‚úÖ PATCH #2: –ø—Ä–æ–≤–µ—Ä–∫–∞ NaN –∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞
    if (isNaN(price) || isNaN(slPrice) || price === slPrice || slPrice === 0) {
      slInput.style.borderColor = 'var(--red)';
      return false;
    }

    if ((isLong && slPrice >= price) || (!isLong && slPrice <= price)) {
      slInput.style.borderColor = 'var(--red)';
      priceInput.style.borderColor = 'var(--red)';
      return false;
    } else {
      slInput.style.borderColor = 'var(--border)';
      priceInput.style.borderColor = 'var(--border)';
      return true;
    }
  }

  ['price','slPrice','priceStep'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateSLinSteps);
  });

  function calculate() {
    if (!checkDOMIntegrity()) {
      alert('‚ö†Ô∏è –î–µ–º–æ-—Ä–µ–∂–∏–º –ø–æ–≤—Ä–µ–∂–¥—ë–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
      return;
    }
    if (!demoGuardPassed) {
      alert('‚ö†Ô∏è –î–µ–º–æ-—Ä–µ–∂–∏–º –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–∞—Ä—É—à–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
      return;
    }
    if (!validateSL()) return;

    const depo = +document.getElementById('depo').value;
    const go = +document.getElementById('go').value;
    const risk = +document.getElementById('riskRub').value;
    const sl = +document.getElementById('sl').value;
    const stepCost = +document.getElementById('stepCost').value || 1;
    const atrRaw = +document.getElementById('atr').value;

    if (sl <= 0) {
      document.getElementById('out').textContent = '‚ö†Ô∏è SL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0';
      return;
    }

    let N;
    if (go === 0) {
      N = Math.floor(risk / sl);
      if (N <= 0) {
        document.getElementById('out').textContent = '‚ö†Ô∏è –†–∏—Å–∫ –º–µ–Ω—å—à–µ –ø–æ—Ç–µ—Ä—å –Ω–∞ 1 –ª–æ—Ç ‚Üí 0 –ª–æ—Ç–æ–≤';
        return;
      }
    } else {
      const maxLotsByDepo = Math.floor(depo / go);
      const maxLotsByRisk = Math.floor(risk / sl);
      N = Math.min(maxLotsByDepo, maxLotsByRisk);
      if (N <= 0) {
        document.getElementById('out').textContent = '‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–ø–æ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π SL';
        return;
      }
    }

    let TP = [
      Math.round(1.0 * sl),
      Math.round(1.5 * sl),
      Math.round(2.0 * sl),
      Math.round(3.0 * sl)
    ];
    if (!isNaN(atrRaw) && atrRaw > 0) {
      const atr = atrRaw;
      TP = [
        Math.min(TP[0], Math.round(0.5 * atr)),
        Math.min(TP[1], Math.round(1.0 * atr)),
        Math.min(TP[2], Math.round(1.5 * atr)),
        Math.min(TP[3], Math.round(2.0 * atr))
      ];
    }

    const w = profiles[currentProfile];
    let [a, b, c] = w.map(x => Math.round(N * x));
    let d = N - a - b - c;
    if (d < 0) { a += d; d = 0; }
    const lots = [a, b, c, d].map(x => Math.max(0, x));

    const price = +document.getElementById('price').value;
    const isLong = document.getElementById('btnLong').classList.contains('active');
    const priceStep = +document.getElementById('priceStep').value || 0.01;

    const tp1Price = (isLong ? price + TP[0] * priceStep : price - TP[0] * priceStep).toFixed(2);
    const tp2Price = (isLong ? price + TP[1] * priceStep : price - TP[1] * priceStep).toFixed(2);
    const tp3Price = (isLong ? price + TP[2] * priceStep : price - TP[2] * priceStep).toFixed(2);
    const tp4Price = (isLong ? price + TP[3] * priceStep : price - TP[3] * priceStep).toFixed(2);

    document.getElementById('tp1Price').value = tp1Price;
    document.getElementById('tp2Price').value = tp2Price;
    document.getElementById('tp3Price').value = tp3Price;
    document.getElementById('tp4Price').value = tp4Price;

    const visualDots = lots.map(l => l ? '‚Ä¢'.repeat(l) : '‚Äì').join('|');
    const visualNumbers = lots.join('|');
    document.getElementById('schemeVis').textContent = visualDots;

    const rr = (TP[2] / sl).toFixed(1);
    const rrDisplay = isNaN(atrRaw) || atrRaw <= 0 
      ? `R:R ‚âà ${rr}` 
      : `R:R ‚âà ${rr} (ATR=${atrRaw})`;
    document.getElementById('rrDisplay').textContent = rrDisplay;

    const profit = D => lots.reduce((s, l, i) => s + (D >= TP[i] ? l * TP[i] * stepCost : 0), 0);
    document.getElementById('out').innerHTML = `
–°—Ö–µ–º–∞: ${visualNumbers}
–ü—Ä–∏–±—ã–ª—å:
  TP1=${TP[0]} –ø. (R:R=${(TP[0]/sl).toFixed(1)}) = ${profit(TP[0])} ‚ÇΩ
  TP2=${TP[1]} –ø. (R:R=${(TP[1]/sl).toFixed(1)}) = ${profit(TP[1])} ‚ÇΩ
  TP3=${TP[2]} –ø. (R:R=${(TP[2]/sl).toFixed(1)}) = ${profit(TP[2])} ‚ÇΩ
  TP4=${TP[3]} –ø. (R:R=${(TP[3]/sl).toFixed(1)}) = ${profit(TP[3])} ‚ÇΩ
`.trim();

    if (typeof window.incrCalcCount === 'function') window.incrCalcCount();
  }

  document.getElementById('btnCalc').addEventListener('click', calculate);

  function safeParseLog() {
    try {
      const data = localStorage.getItem('voltaLog');
      if (!data) return [];
      const parsed = JSON.parse(data);
      if (Array.isArray(parsed) && parsed.every(item => 
        item && typeof item === 'object' && item.time && item.ticker)) {
        return parsed;
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è localStorage "voltaLog" –ø–æ–≤—Ä–µ–∂–¥—ë–Ω ‚Äî —Å–±—Ä–æ—à–µ–Ω.');
    }
    localStorage.removeItem('voltaLog');
    return [];
  }

  let log = safeParseLog();

  function renderLog() {
    if (!demoGuardPassed) return;
    const t = document.getElementById('logBody');
    if (log.length === 0) {
      t.innerHTML = '<tr><td colspan="8" style="text-align:center">‚Äî –ø—É—Å—Ç–æ ‚Äî</td></tr>';
      return;
    }
    t.innerHTML = log.map(r => {
      const tpRubStr = r.tpLevelsRub.map(tp => 
        tp.lots > 0 ? `${tp.lots}√ó${tp.rub}` : '‚Äì'
      ).join(' | ');
      return `
        <tr>
          <td>${r.time}</td>
          <td>${r.ticker}</td>
          <td>${r.position}</td>
          <td>${r.schemeNumbers}</td>
          <td>${r.lots}</td>
          <td>${r.slPts}</td>
          <td>${tpRubStr}</td>
          <td>+${r.totalProfitRub} ‚ÇΩ</td>
        </tr>
      `;
    }).join('');
  }

  document.getElementById('btnLog').addEventListener('click', () => {
    calculate();
    const outText = document.getElementById('out').textContent;
    if (outText.includes('‚ö†Ô∏è')) {
      alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏.');
      return;
    }

    const price = +document.getElementById('price').value;
    const slPrice = +document.getElementById('slPrice').value;
    const isLong = document.getElementById('btnLong').classList.contains('active');
    if ((isLong && slPrice >= price) || (!isLong && slPrice <= price)) {
      alert('‚ö†Ô∏è SL –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—ã.');
      return;
    }

    const depo = +document.getElementById('depo').value;
    const riskRub = +document.getElementById('riskRub').value;
    const stepCost = +document.getElementById('stepCost').value || 1;
    const sl = +document.getElementById('sl').value;

    const sel = document.getElementById('instr');
    const instrText = sel.options[sel.selectedIndex].text;
    let ticker = instrText.split(' (')[0];
    if (ticker === '–°–≤–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç') {
      ticker = document.getElementById('customTickerInput').value.trim() || '???';
    }

    const pos = isLong ? 'Long' : 'Short';
    const go = +document.getElementById('go').value;
    let N;
    if (go === 0) {
      N = Math.floor(riskRub / sl);
    } else {
      const maxLotsByDepo = Math.floor(depo / go);
      const maxLotsByRisk = Math.floor(riskRub / sl);
      N = Math.min(maxLotsByDepo, maxLotsByRisk);
    }

    if (N <= 0) {
      alert('‚ö†Ô∏è –ù–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é: —Ä–∏—Å–∫ —Å–ª–∏—à–∫–æ–º –º–∞–ª –∏–ª–∏ SL —Å–ª–∏—à–∫–æ–º –≤–µ–ª–∏–∫.');
      return;
    }

    const w = profiles[currentProfile];
    let [aa, bb, cc] = w.map(x => Math.round(N * x));
    let dd = N - aa - bb - cc;
    if (dd < 0) { aa += dd; dd = 0; }
    const lots = [aa, bb, cc, dd].map(x => Math.max(0, x));
    const visualNumbers = lots.join('|');

    const atrRaw = +document.getElementById('atr').value;
    let TP = [Math.round(1.0*sl), Math.round(1.5*sl), Math.round(2.0*sl), Math.round(3.0*sl)];
    if (!isNaN(atrRaw) && atrRaw > 0) {
      const atr = atrRaw;
      TP = [
        Math.min(TP[0], Math.round(0.5 * atr)),
        Math.min(TP[1], Math.round(1.0 * atr)),
        Math.min(TP[2], Math.round(1.5 * atr)),
        Math.min(TP[3], Math.round(2.0 * atr))
      ];
    }

    const tpRub = TP.map((steps, i) => ({ 
      level: i + 1, 
      steps,
      lots: lots[i], 
      rub: lots[i] * steps * stepCost 
    }));

    const entry = {
      time: new Date().toLocaleString('ru-RU', { 
        year: '2-digit', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false 
      }).replace(',', ''),
      ticker,
      position: pos,
      depo,
      riskRub,
      slPts: sl,
      priceStep: +document.getElementById('priceStep').value,
      stepCost,
      lots: N,
      schemeNumbers: visualNumbers,
      profile: currentProfile,
      tpLevelsRub: tpRub,
      totalProfitRub: tpRub.reduce((s, t) => s + t.rub, 0)
    };

    log.unshift(entry);

    if (log.length > 50) log.length = 50;

    // ‚úÖ PATCH #3: –∑–∞—â–∏—Ç–∞ –æ—Ç QuotaExceededError
    try {
      localStorage.setItem('voltaLog', JSON.stringify(log));
    } catch (e) {
      if (e.name === 'QuotaExceededError') {
        alert('‚ö†Ô∏è –ñ—É—Ä–Ω–∞–ª –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω. –û—á–∏—â–µ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π 1/3 –∑–∞–ø–∏—Å–µ–π.');
        log = log.slice(0, Math.floor(log.length * 2 / 3));
        try {
          localStorage.setItem('voltaLog', JSON.stringify(log));
        } catch (e2) {
          alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞. –û—á–∏—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.');
        }
      }
    }

    renderLog();
  });

  document.getElementById('btnClearLog').addEventListener('click', () => {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∂—É—Ä–Ω–∞–ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
      log = [];
      try { localStorage.removeItem('voltaLog'); } catch (e) {}
      renderLog();
      if (confirm('–¢–∞–∫–∂–µ –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã?')) {
        localStorage.removeItem('voltaInstruments');
        updateSavedInstruments();
      }
    }
  });

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  }

  document.getElementById('btnExpExcel').addEventListener('click', () => {
    if (log.length === 0) return alert('–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç');
    const header = ['–í—Ä–µ–º—è','–¢–∏–∫–µ—Ä','–ü–æ–∑–∏—Ü–∏—è','–°—Ö–µ–º–∞','–õ–æ—Ç–æ–≤','–î–µ–ø–æ','–†–∏—Å–∫, ‚ÇΩ','SL, —à–∞–≥–∏','TP1','TP2','TP3','TP4','–ü—Ä–∏–±—ã–ª—å'];
    const rows = log.map(r => [
      r.time, r.ticker, r.position, r.schemeNumbers, r.lots, r.depo, r.riskRub, r.slPts,
      r.tpLevelsRub[0].rub, r.tpLevelsRub[1].rub, r.tpLevelsRub[2].rub, r.tpLevelsRub[3].rub,
      r.totalProfitRub
    ]);
    const csv = [header.join(';'), ...rows.map(r => r.map(String).join(';'))].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    downloadBlob(blob, `VoltaDesk_${new Date().toISOString().slice(0,10)}.csv`);
  });

  document.getElementById('btnExpWord').addEventListener('click', () => {
    if (log.length === 0) return alert('–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç');
    const txt = `VoltaDesk Pro Futures ‚Äî –ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫\n` + 
      log.map((r, i) => 
        `${i+1}. ${r.time} | ${r.ticker} | ${r.position} | —Å—Ö–µ–º–∞: ${r.schemeNumbers} | –ø—Ä–∏–±—ã–ª—å: +${r.totalProfitRub} ‚ÇΩ`
      ).join('\n');
    const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
    downloadBlob(blob, `VoltaDesk_${new Date().toISOString().slice(0,10)}.txt`);
  });

  document.getElementById('btnBackup').addEventListener('click', () => {
    const backup = {
      version: 'V2.4.1',
      timestamp: Date.now(),
      log: log,
      config: {
        depo: +document.getElementById('depo').value,
        riskRub: +document.getElementById('riskRub').value,
        go: +document.getElementById('go').value,
        priceStep: +document.getElementById('priceStep').value,
        stepCost: +document.getElementById('stepCost').value
      }
    };
    const blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json;charset=utf-8'});
    downloadBlob(blob, `volta_backup_${new Date().toISOString().slice(0,10)}.json`);
    alert('‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω.');
  });

  document.getElementById('btnHelp').onclick = () => {
    document.getElementById('helpModal').style.display = 'flex';
  };

  const helpModal = document.getElementById('helpModal');
  helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) {
      helpModal.style.display = 'none';
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && helpModal.style.display === 'flex') {
      helpModal.style.display = 'none';
    }
  });

  syncRisk();
  updateSLinSteps();
  calculate();
  renderLog();
  dlog('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
});
</script>
</body>
</html>